<?php

use Ezzaze\SsimParser\Exceptions\{EmptyDataSourceException, InvalidContractException, InvalidRegexClassException, InvalidVersionClassException};
use Ezzaze\SsimParser\SsimParser;
use Ezzaze\SsimParser\Versions\Version3;

$data = "
    1AIRLINE STANDARD SCHEDULE DATA SET     1                                                                                                                                                      001000001
    00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    2LME  0008S22 27MAR2226MAR2315JUL22                             13JUN22C NetLine/Sched  2016.2.8                                                                                              0749000002
    00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    3 ME  5010101J03JUL2223OCT22      7 EVN07000700+0400  HRG08400840+0200  320                                                              ME  502                            Y174                00000003
    3 ME  5010201J06JUL2226OCT22  3     EVN09200920+0400  HRG11001100+0200  320                                                              ME  502                            Y174                00000004
    3 ME  5020101J03JUL2223OCT22      7 HRG09200920+0200  EVN14351435+0400  320                                                              ME  503                            Y174                00000005
    3 ME  5020201J06JUL2206JUL22  3     HRG11401140+0200  EVN16551655+0400  320                                                              ME  5032                           Y174                00000006
    3 ME  5020301J13JUL2226OCT22  3     HRG11401140+0200  EVN16551655+0400  320                                                              ME  503                            Y174                00000007
    3 ME  5030101J04JUL2229OCT221    6  EVN11001100+0400  SSH12251225+0200  320                                                              ME  504                            Y174                00000008
    3 ME  5030201J13JUL2226OCT22  3     EVN17551755+0400  SSH19201920+0200  320                                                              ME  504                            Y174                00000009
    3 ME  5040101J04JUL2224OCT221       SSH13051305+0200  EVN18051805+0400  320                                                              ME  5011                           Y174                00000010
    3 ME  5040201J09JUL2222OCT22     6  SSH13051305+0200  EVN18051805+0400  320                                                              ME  501                            Y174                00000011
    3 ME  5040301J13JUL2226OCT22  3     SSH20002000+0200  EVN01000100+0400  320                                                              ME  5032                           Y174                01000012
    3 ME  5040401J29OCT2229OCT22     6  SSH13051305+0200  EVN18051805+0400  320                                                                                                 Y174                00000013
    00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    5 ME                                                                                                                                                                                       000013E000014
    00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
";

it('can extract SSIM v3 data', function () use ($data) {
    $ssim = (new SsimParser(new Version3()))->load($data);
    $output = $ssim->parse();

    expect($output)->toBeArray();
    expect(count($output))->toBeGreaterThan(0);

    expect($output[0])->toHaveKeys([
        'uid',
        'airline_designator',
        'service_type',
        'flight_number',
        'departure_datetime',
        'arrival_datetime',
        'departure_utc_datetime',
        'arrival_utc_datetime',
        'departure_iata',
        'arrival_iata',
        'aicraft_type',
        'aicraft_configuration',
    ]);
});

it('throws invalid version class exception', function () use ($data) {
    $ssim = (new SsimParser())->setVersion('NonExistentVersionClass')->load($data);
    $ssim->parse();
})->throws(InvalidVersionClassException::class, 'Class NonExistentVersionClass does not exist.');

it('returns empty list on invalid source', function () {
    $ssim = (new SsimParser())->load("this is not a valid SSIM string");
    $output = $ssim->parse();

    expect($output)->toBeArray();
    expect($output)->toBeEmpty();
});

it('throws invalid regex class exception', function () use ($data) {
    $ssim = (new SsimParser())->setRegex('NonExistentRegexClass')->load($data);
    $ssim->parse();
})->throws(InvalidRegexClassException::class, 'Class NonExistentRegexClass does not exist.');

it('throws invalid contract exception', function () use ($data) {
    $ssim = (new SsimParser())->setVersion(get_class(new class () {}))->load($data);
    $ssim->parse();
})->throws(InvalidContractException::class);

it('throws empty data source exception', function () {
    $ssim = new SsimParser();
    $ssim->load("");
})->throws(EmptyDataSourceException::class, 'Data source cannot be empty.');
